<!DOCTYPE html>
<html lang="en">
<head>

    <title>GoLang GenAI Stack</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta charset="utf-8">
  
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <script type="module" src="js/beer.min.js"></script>
    <script type="module" src="js/material-dynamic-colors.min.js"></script>
    
    <script src="./js/markdown-it.min.js"></script>

    <link rel="stylesheet" href="css/beer.min.css">

    <script src="js/htmx.min.js"></script>

</head>

<body>
    <main class="responsive">

        <h5 class="max center-align">ü©µ GoLang üê≥ Docker ü¶ô GenAI Stack ü¶úü™∫</h5>

        <fieldset>
            <legend 
                hx-get="/model" 
                hx-trigger="load"
                hx-target="#model"
            >
            Demo with <span id="model"></span></legend>

            <div id="prompt-form" class="field border label textarea">
              <textarea id="human-message">
              </textarea>
              <label>Prompt</label>
              <span class="helper">Type your question above ‚òùÔ∏è</span>
            </div>
            
            <div class="field border label">
                <button class="small-round" hx-trigger="click[prompt()]">
                    <i>home</i>
                    <span>Send Prompt</span>
                </button>

                <button class="small-round" hx-trigger="click[stop()]">
                    <i>stop</i>
                    <span>Stop</span>
                </button>

                <button class="small-round" hx-trigger="click[clear()]">
                    <i>clear</i>
                    <span>Clear the answer</span>
                </button>
            </div>

          </fieldset>

          <div class="field border label">
            <div id="txt-response">
            </div>
        </div>
    </main>

    <script>

        // Using the htmx:load event
        document.body.addEventListener('htmx:load', function(what) {
            console.log("üëã Page loaded with HTMX", what.srcElement.baseURI);
            document.getElementById('human-message').value = 'Generate an hello world program in Golang?';
        })

        let aborter = new AbortController
        
        async function prompt() {
            let responseText=""

            try {
                const humanMessage = document.getElementById('human-message').value;
                console.log('Question:', humanMessage);

                const response = await fetch("/prompt", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json;charset=utf-8",
                    },
                    body: JSON.stringify({
                        question: humanMessage,
                    }),
                    signal: aborter.signal
                })

                const reader = response.body.getReader()

                while (true) {
                    const { done, value } = await reader.read()
                        
                    if (done) {
                        responseText = responseText + "\n"
                        changeResponseContent(markdownit().render(responseText))
                        return
                    }
                    // Otherwise do something here to process current chunk
                    const decodedValue = new TextDecoder().decode(value)
                    console.log(decodedValue)
                    responseText = responseText + decodedValue
                    changeResponseContent(markdownit().render(responseText))

                }

            } catch(error) {
                if (error.name === 'AbortError') {
                console.log("‚úã", "Fetch request aborted")
                //txtPrompt.value = ""
                aborter = new AbortController()
    
                try {
                  const response = await fetch("/cancel-request", {
                    method: "DELETE",
                  })
                  console.log(response)
                } catch(error) {
                  console.log("üò°", error)
                }
    
              } else {
                console.log("üò°", error)
              }
            }            
        }

        function stop() {
            aborter.abort()
        }
        function clear() {
            changeResponseContent("")
        }

        function changeResponseContent(message) {
            const responseDiv = document.getElementById('txt-response');
            responseDiv.innerHTML = message;
        }
    </script>
</body>
</html>